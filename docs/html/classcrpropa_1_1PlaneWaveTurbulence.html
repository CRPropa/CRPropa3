<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CRPropa 3.0: PlaneWaveTurbulence Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">CRPropa 3.0
   </div>
   <div id="projectbrief">Tracking</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="namespacecrpropa.html">crpropa</a></li><li class="navelem"><a class="el" href="classcrpropa_1_1PlaneWaveTurbulence.html">PlaneWaveTurbulence</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="classcrpropa_1_1PlaneWaveTurbulence-members.html">List of all members</a>  </div>
  <div class="headertitle"><div class="title">PlaneWaveTurbulence Class Reference<div class="ingroups"><a class="el" href="group__MagneticFields.html">Magnetic Fields</a></div></div></div>
</div><!--header-->
<div class="contents">

<p>Interpolation-free turbulent magnetic field based on the GJ99 and TD13 papers.  
 <a href="classcrpropa_1_1PlaneWaveTurbulence.html#details">More...</a></p>
<div class="dynheader">
Inheritance diagram for PlaneWaveTurbulence:</div>
<div class="dyncontent">
 <div class="center">
  <img src="classcrpropa_1_1PlaneWaveTurbulence.png" usemap="#PlaneWaveTurbulence_map" alt=""/>
  <map id="PlaneWaveTurbulence_map" name="PlaneWaveTurbulence_map">
<area href="classcrpropa_1_1TurbulentField.html" title="An abstract base class for different models of turbulent magnetic fields." alt="TurbulentField" shape="rect" coords="0,112,140,136"/>
<area href="classcrpropa_1_1MagneticField.html" title="Abstract base class for magnetic fields." alt="MagneticField" shape="rect" coords="0,56,140,80"/>
<area href="classcrpropa_1_1Referenced.html" title="Base class for reference counting." alt="Referenced" shape="rect" coords="0,0,140,24"/>
  </map>
</div></div>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pub-methods" name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:afead2098623e128533da59d68f8c5f12"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classcrpropa_1_1PlaneWaveTurbulence.html#afead2098623e128533da59d68f8c5f12">PlaneWaveTurbulence</a> (const <a class="el" href="classcrpropa_1_1TurbulenceSpectrum.html">TurbulenceSpectrum</a> &amp;spectrum, int Nm=64, int seed=0)</td></tr>
<tr class="separator:afead2098623e128533da59d68f8c5f12"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a60b4a9f66e692a5d3620de910bae981e"><td class="memItemLeft" align="right" valign="top"><a class="el" href="classcrpropa_1_1Vector3.html">Vector3d</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classcrpropa_1_1PlaneWaveTurbulence.html#a60b4a9f66e692a5d3620de910bae981e">getField</a> (const <a class="el" href="classcrpropa_1_1Vector3.html">Vector3d</a> &amp;pos) const</td></tr>
<tr class="separator:a60b4a9f66e692a5d3620de910bae981e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a20da6a51e928681782a92b46046e48fb"><td class="memItemLeft" align="right" valign="top"><a id="a20da6a51e928681782a92b46046e48fb" name="a20da6a51e928681782a92b46046e48fb"></a>
double&#160;</td><td class="memItemRight" valign="bottom"><b>getBrms</b> () const</td></tr>
<tr class="separator:a20da6a51e928681782a92b46046e48fb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ade6d13b158fda57508e3483d24328716"><td class="memItemLeft" align="right" valign="top"><a id="ade6d13b158fda57508e3483d24328716" name="ade6d13b158fda57508e3483d24328716"></a>
virtual double&#160;</td><td class="memItemRight" valign="bottom"><b>getCorrelationLength</b> () const</td></tr>
<tr class="separator:ade6d13b158fda57508e3483d24328716"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3b26c25dd12606960327b3f186fae6cf"><td class="memItemLeft" align="right" valign="top"><a id="a3b26c25dd12606960327b3f186fae6cf" name="a3b26c25dd12606960327b3f186fae6cf"></a>
virtual <a class="el" href="classcrpropa_1_1Vector3.html">Vector3d</a>&#160;</td><td class="memItemRight" valign="bottom"><b>getField</b> (const <a class="el" href="classcrpropa_1_1Vector3.html">Vector3d</a> &amp;position, double z) const</td></tr>
<tr class="separator:a3b26c25dd12606960327b3f186fae6cf"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6ef7442f4d857baf3d3a39fdeec4aadd"><td class="memItemLeft" align="right" valign="top"><a id="a6ef7442f4d857baf3d3a39fdeec4aadd" name="a6ef7442f4d857baf3d3a39fdeec4aadd"></a>
size_t&#160;</td><td class="memItemRight" valign="bottom"><b>addReference</b> () const</td></tr>
<tr class="separator:a6ef7442f4d857baf3d3a39fdeec4aadd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab9f5dbbba1431274016b3d74426953f2"><td class="memItemLeft" align="right" valign="top"><a id="ab9f5dbbba1431274016b3d74426953f2" name="ab9f5dbbba1431274016b3d74426953f2"></a>
size_t&#160;</td><td class="memItemRight" valign="bottom"><b>removeReference</b> () const</td></tr>
<tr class="separator:ab9f5dbbba1431274016b3d74426953f2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:adab41cca5664d4668930f93beefa39b5"><td class="memItemLeft" align="right" valign="top"><a id="adab41cca5664d4668930f93beefa39b5" name="adab41cca5664d4668930f93beefa39b5"></a>
int&#160;</td><td class="memItemRight" valign="bottom"><b>removeReferenceNoDelete</b> () const</td></tr>
<tr class="separator:adab41cca5664d4668930f93beefa39b5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a74487fc4399bfa67c7251dae5d4247cd"><td class="memItemLeft" align="right" valign="top"><a id="a74487fc4399bfa67c7251dae5d4247cd" name="a74487fc4399bfa67c7251dae5d4247cd"></a>
size_t&#160;</td><td class="memItemRight" valign="bottom"><b>getReferenceCount</b> () const</td></tr>
<tr class="separator:a74487fc4399bfa67c7251dae5d4247cd"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p >Interpolation-free turbulent magnetic field based on the GJ99 and TD13 papers. </p>
<h2><a class="anchor" id="autotoc_md0"></a>
Overview</h2>
<p >This class provides a turbulent magnetic field that is generated as described by <a href="https://doi.org/10.1086/307452">(Giacalone and Jokipii, 1999)</a> and <a href="https://doi.org/10.1063/1.4789861">(Tautz and Dosch, 2013)</a>. Instead of using an inverse Fourier transform to generate the field on a grid &ndash; which then needs to be interpolated to obtain in-between values &ndash; this method only generates the wave modes making up the turbulent magnetic field ahead of time. At run time, when the field's value at a particular position is required, these plane waves are then evaluated analytically at that position. This guarantees that the resulting field is completely free of divergence, reproduces the mean field strength accurately, and does not suffer from other interpolation-induced problems. The disadvantage is that the number of wave modes is drastically smaller when compared with initTurbulence, which might have physical ramifications on the particles propagating through the field. Furthermore, depending on the exact setting, the implementation is somewhat slower (see Schlegel et al. for details).</p>
<h2><a class="anchor" id="autotoc_md1"></a>
Using the SIMD optimization</h2>
<p >In order to mitigate some of the performance impact that is inherent in this method of field generation, an optimized version is provided. According to our tests (see the paper above), this version runs 20-30x faster than the baseline implementation and matches the speed of trilinear interpolation on a grid at a bit less than 100 wavemodes. To do this, it uses special CPU instructions called AVX, which are unfortunately not supported by every CPU. On Linux, you can check whether your CPU supports AVX by using the <code>lscpu</code> command, and searching the flags section for the string "avx". Alternatively, if you are building on the same CPU that CRPropa will run on, you can have the compiler detect this for you automatically (see below).</p>
<p >An additional speedup of about 1.33 can be achieved if the CPU supports the FMA extension in addition to AVX. Again, you can either check for this manually, or have the compiler figure it out for you.</p>
<p >Note** that the optimized and non-optimized implementations to not return the exact same results. In fact, since the effective wave numbers used by the optimized implementation are very slightly different from those used by the non-optimized version (a difference smaller than the precision of a double, but nevertheless relevant at some point), the wavemodes go out of phase for large distances from the origin, and the fields are no longer comparable at all.</p>
<h3><a class="anchor" id="autotoc_md2"></a>
If you are building on the same machine that the code will run on:</h3>
<ol type="1">
<li>In cmake: enable the FAST_WAVES flag.</li>
<li>Also in cmake: set SIMD_EXTENSIONS to "native". The compiler will automatically detect support for your CPU and run the build with the appropriate settings.</li>
<li>Generate files and exit cmake, then build.</li>
</ol>
<ol type="1">
<li>If your CPU does not support the necessary extensions, the build will fail with an error telling you so. In this case, you won't be able to use the optimization; go back into cmake, disable FAST_WAVES, and build again.</li>
<li>If the build runs through without errors, the code is built with the optimization.</li>
</ol>
<h3><a class="anchor" id="autotoc_md3"></a>
If you are building on a different machine from the one where the code will run:</h3>
<ol type="1">
<li>Figure out which extensions your target machine supports, using <code>lscpu | grep avx</code> for AVX, and <code>lscpu | grep fma</code> for FMA. Run these commands on your target machine, not on your build machine. If your target machine does not run Linux, you may have to use different commands.</li>
<li>If the CPU does not support AVX, you can stop here, and build normally. The CPU does not support the necessary extensions, and will not run code that is compiled using them.</li>
<li>If the CPU does support AVX, continue. In cmake, enable the FAST_WAVES flag.</li>
<li>Also in cmake, set SIMD_EXTENSIONS to the appropriate value. If your target CPU supports only AVX, but not FMA, set it to "avx". If it supports both, set it to "avx+fma".</li>
<li>Generate and exit cmake, then build.</li>
<li>If you made a mistake and used the wrong flags, you should see an illegal instruction error when trying to import CRPropa, or (at the latest) when trying to call <code>getField</code>. </li>
</ol>
</div><h2 class="groupheader">Constructor &amp; Destructor Documentation</h2>
<a id="afead2098623e128533da59d68f8c5f12" name="afead2098623e128533da59d68f8c5f12"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afead2098623e128533da59d68f8c5f12">&#9670;&nbsp;</a></span>PlaneWaveTurbulence()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classcrpropa_1_1PlaneWaveTurbulence.html">PlaneWaveTurbulence</a> </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="classcrpropa_1_1TurbulenceSpectrum.html">TurbulenceSpectrum</a> &amp;&#160;</td>
          <td class="paramname"><em>spectrum</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>Nm</em> = <code>64</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>seed</em> = <code>0</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p >Create a new instance of <a class="el" href="classcrpropa_1_1PlaneWaveTurbulence.html" title="Interpolation-free turbulent magnetic field based on the GJ99 and TD13 papers.">PlaneWaveTurbulence</a> with the specified parameters. This generates all of the wavemodes according to the given parameters. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">Nm</td><td>number of wavemodes that will be used when computing the field. A higher value will give a more accurate representation of the turbulence, but increase the runtime for getField. </td></tr>
    <tr><td class="paramname">seed</td><td>can be used to seed the random number generator used to generate the field. This works just like in initTurbulence: a seed of 0 will lead to a randomly initialized RNG. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<h2 class="groupheader">Member Function Documentation</h2>
<a id="a60b4a9f66e692a5d3620de910bae981e" name="a60b4a9f66e692a5d3620de910bae981e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a60b4a9f66e692a5d3620de910bae981e">&#9670;&nbsp;</a></span>getField()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="classcrpropa_1_1Vector3.html">Vector3d</a> getField </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="classcrpropa_1_1Vector3.html">Vector3d</a> &amp;&#160;</td>
          <td class="paramname"><em>pos</em></td><td>)</td>
          <td> const</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">virtual</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p >Evaluates the field at the given position.</p>
<p >Theoretical runtime is O(Nm), where Nm is the number of wavemodes. </p>

<p>Reimplemented from <a class="el" href="classcrpropa_1_1MagneticField.html">MagneticField</a>.</p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Dec 18 2021 22:26:10 for CRPropa 3.0 by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2
</small></address>
</body>
</html>
